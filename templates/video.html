{% extends "base.html" %}
{% block title %}{{ video.title }} - CodeTube{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
{% endblock %}

{% block content %}
<div class="video-page">
  <div class="video-main">
    <div class="player-wrapper">
      <video controls class="video-player">
        <source src="{{ url_for('static', filename='uploads/' ~ video.filename) }}" type="video/mp4">
      </video>
    </div>

    <h2 class="video-title">{{ video.title }}</h2>

    <div class="video-meta">
      <div class="uploader">
        <span class="u-name">{{ video.username }}</span>
        <button class="btn-subscribe">Seguir</button>
      </div>
      <div class="actions">
        <button class="btn-like">游녨</button>
        <button class="btn-dislike">游녩</button>
        <span class="views">{{ video.views or 0 }} visualizaciones 췅 {{ video.date }}</span>

        {% if user and (user.user_id == video.user_id or user.role == 'admin') %}
        <div class="action-manage">
          <a class="btn-edit" href="{{ url_for('upload_page') }}?edit={{ video._id }}">Editar</a>
          <button id="deleteVideoBtn" class="btn-delete" type="button">Eliminar</button>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="description">
      <p>{{ video.description }}</p>
    </div>

    <!-- Editor r치pido y ejecutor -->
    <section class="code-runner-section">
      <h3>Editor r치pido (JavaScript)</h3>
      <div id="jsEditor" class="code-editor" data-code='{{ video.code | default("", true) | tojson }}'></div>
      <div class="editor-actions">
        <button id="runCodeBtn" class="btn-edit">Ejecutar</button>
        <button id="stopCodeBtn" class="btn-edit">Detener</button>
        <button id="clearOutputBtn" class="btn-edit">Limpiar</button>
        {% if user and (user.user_id == video.user_id or user.role == 'admin') %}
          <button id="saveCodeBtn" class="btn-edit">Guardar</button>
        {% endif %}
      </div>
      <div id="editorOutput" class="editor-output" aria-live="polite"></div>
    </section>

    <section class="comments-section">
      <h3>Comentarios ({{ comments|length }})</h3>
      {% if user %}
      <form id="commentForm" onsubmit="return false;">
        <textarea id="commentText" placeholder="A침ade un comentario..." required></textarea>
        <button id="postComment" type="button">Comentar</button>
      </form>
      {% else %}
      <p><a href="{{ url_for('login_page') }}">Inicia sesi칩n</a> para comentar.</p>
      {% endif %}

      <ul id="commentsList" class="comments-list">
        {% for c in comments %}
        <li class="comment">
          <div class="comment-author">{{ c.author }}</div>
          <div class="comment-text">{{ c.text }}</div>
          <div class="comment-date">{{ c.created_at }}</div>
        </li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <aside class="video-side">
    {% for s in suggestions %}
    <a class="suggestion" href="{{ url_for('video_page', video_id=s._id) }}">
      <div class="thumb" style="background-image: url('{{ url_for('static', filename='uploads/' ~ s.filename) }}');"></div>
      <div class="s-info">
        <div class="s-title">{{ s.title }}</div>
        <div class="s-user">{{ s.username }}</div>
      </div>
    </a>
    {% endfor %}
  </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
<script src="{{ url_for('static', filename='editor-run.js') }}"></script>
<script src="{{ url_for('static', filename='video.js') }}"></script>
{% endblock %}